<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Medical Management System — Secure & Responsive</title>

<!-- Font + jsPDF kept as original -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
/* =======================
   Base Reset & Utilities
   ======================= */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:'Poppins',sans-serif;
  background: linear-gradient(180deg,#071226,#052935);
  color:#0b1720;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  overflow:hidden; /* app area handles inner scroll */
}

/* =======================
   Fullscreen Layout
   ======================= */
#root {
  height:100vh;
  width:100vw;
  display:flex;
  align-items:stretch;
  justify-content:center;
}

/* =======================
   Particle background (floating soft circles)
   ======================= */
.particles-canvas {
  position:fixed;
  inset:0;
  z-index:0;
  pointer-events:none;
  background: linear-gradient(135deg, rgba(4,12,18,0.6) 0%, rgba(3,27,29,0.6) 100%);
  backdrop-filter: blur(4px);
}

/* soft glow overlay moving */
.soft-glow {
  position:fixed;
  inset:0;
  z-index:0;
  background:
    radial-gradient(800px 600px at 10% 20%, rgba(29,192,165,0.07), transparent 10%),
    radial-gradient(700px 500px at 90% 80%, rgba(27,46,102,0.06), transparent 10%);
  mix-blend-mode: overlay;
  animation: glowShift 12s infinite linear;
}
@keyframes glowShift{
  0%{transform:translateY(0)}
 50%{transform:translateY(20px)}
 100%{transform:translateY(0)}
}

/* =======================
   Auth Card (glass) - Full Screen responsive
   ======================= */
.auth-wrap {
  position: fixed;
  inset: 0;
  z-index: 999;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  background: rgba(0,0,0,0.4);
}

/* Card container */
.auth-card {
  position: relative;
  width: 1100px;
  max-width: 95%;
  height: 640px;
  border-radius: 16px;
  overflow: hidden;
  display: grid;
  grid-template-columns: 1fr 1fr;
  box-shadow: 0 30px 80px rgba(2,6,23,0.6);
  backdrop-filter: blur(10px) saturate(120%);
  background: rgba(255,255,255,0.05);
  animation: cardIn .5s ease;
}

/* Entrance animation */
@keyframes cardIn {
  from { opacity:0; transform: translateY(10px) scale(.995); }
  to { opacity:1; transform: translateY(0) scale(1); }
}

/* Left panel */
.auth-left {
  background: linear-gradient(180deg, rgba(0, 0, 0, 0.7), rgba(46,204,113,0.7));
  color: #fff;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  padding: 36px;
  gap: 12px;
  animation: slideInLeft 0.6s ease forwards;
}
@keyframes slideInLeft {
  from { opacity:0; transform: translateX(-30px);}
  to { opacity:1; transform: translateX(0);}
}

.brand-title { font-size:28px; font-weight:700; letter-spacing:0.2px; }
.brand-sub { font-size:13px; opacity:0.9; margin-top:4px; }

.logo-wrap {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top:12px;
}
.logo {
  width: 68px;
  height: 68px;
  border-radius: 12px;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 8px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}
.logo img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

/* Right panel */
.auth-right {
  background: rgba(255,255,255,0.95);
  display: flex;
  flex-direction: column;
  padding: 28px;
  gap: 12px;
  animation: slideInRight 0.6s ease forwards;
}
@keyframes slideInRight {
  from { opacity:0; transform: translateX(30px);}
  to { opacity:1; transform: translateX(0);}
}

/* Tabs */
.auth-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}
.tab-btn {
  flex:1;
  text-align: center;
  padding: 10px 12px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  border: 1px solid transparent;
  transition: all 0.3s ease;
}
.tab-btn.active {
  background: linear-gradient(90deg,#ffffff,#f1f7f6);
  color: #0b5549;
  border-color: #e6f3ef;
  box-shadow: 0 4px 18px rgba(28,57,51,0.06);
}
.tab-btn:hover { opacity: 0.9; }

/* Inputs */
.input-group {
  position: relative;
  display: flex;
  gap: 8px;
  align-items: center;
}
.input {
  width: 100%;
  padding: 12px 14px;
  border-radius: 8px;
  border: 1px solid #0a0a0a;
  font-size: 14px;
  transition: all 0.2s ease;
}
.input:focus {
  outline: none;
  border-color: #0076bf;
  box-shadow: 0 6px 18px rgba(26,188,156,0.06);
}
.toggle-pass {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 13px;
  color: #1abc9c;
  cursor: pointer;
  font-weight: 600;
}

/* Buttons */
.btn-group {
  display: flex;
  gap: 10px;
  margin-top: 8px;
}
button.primary {
  flex: 1;
  background: linear-gradient(90deg,#1abc9c,#16a085);
  color: #fff;
  border: none;
  padding: 12px 14px;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(24,138,128,0.14);
  transition: all 0.25s ease;
}
button.primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 28px rgba(24,138,128,0.18);
}
button.ghost {
  flex: 1;
  background: transparent;
  border: 1px solid #ccc;
  border-radius: 10px;
  cursor: pointer;
  color: #2b2b2b;
  padding: 8px;
  transition: all 0.2s ease;
}
button.ghost:hover { color:#1abc9c; border-color:#1abc9c; }

/* Field row */
.field-row { display: flex; gap: 8px; }

/* Panel footer row */
.auth-footer-row { display:flex; justify-content:space-between; font-size:0.85rem; color:#666; }
.small { font-size:13px; color:#556; margin-top:4px; }

/* Panel fade-in */
.auth-panel { display:flex; flex-direction:column; gap:12px; animation: fadeIn 0.4s ease; }
@keyframes fadeIn { 0%{opacity:0; transform: translateY(-5px);} 100%{opacity:1; transform:translateY(0);} }

/* Responsive */
@media (max-width: 900px) {
  .auth-card { grid-template-columns: 1fr; width: 95%; height:auto; }
  .auth-left, .auth-right { padding:24px; }
  .field-row { flex-direction: column; }
}

/* =======================
   The App content (dashboard) - full screen responsive
   ======================= */
#app {
  display:none; /* start hidden until auth */
  position:relative;
  z-index:3;
  width:100vw;
  height:100vh;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
}

/* header */
.header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:20px 28px;
  background:linear-gradient(90deg,#2c3e50,#1abc9c);
  color:white;
  box-shadow:0 8px 30px rgba(0,0,0,0.18);
}
.header-left{display:flex;flex-direction:column;gap:4px}
.header-actions{display:flex;gap:10px;align-items:center}

/* nav */
nav{background-color:#34495e;display:flex;justify-content:center;flex-wrap:wrap;padding:10px 0;position:sticky;top:0;z-index:2}
nav a{color:white;text-decoration:none;padding:12px 20px;margin:5px;border-radius:6px;transition:.25s}
nav a:hover{background-color:#1abc9c;color:white}

/* page container */
.container{max-width:1200px;margin:20px auto;padding:20px}
.counters{display:flex;flex-wrap:wrap;gap:20px;margin-bottom:20px}
.counter{background:white;padding:20px;border-radius:12px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,0.08);flex:1;min-width:150px}
.counter h2{font-size:1.8em;color:#1abc9c}
.section{margin:20px 0;padding:20px;background:white;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.05)}
.section h2{color:#2c3e50;margin-bottom:12px}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{border:1px solid #ddd;padding:10px;text-align:left}
th{background-color:#2c3e50;color:white}
td button{margin:0 3px;padding:5px 8px}
button{background-color:#1abc9c;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;margin:5px 0;font-weight:600;transition:.25s}
button:hover{background-color:#16a085}

/* modal */
.modal{display:none;position:fixed;z-index:999;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.5)}
.modal-content{background:white;margin:6% auto;padding:20px;border-radius:12px;width:90%;max-width:520px;box-shadow:0 5px 15px rgba(0,0,0,0.3)}
.modal-content input,.modal-content select{width:100%;padding:8px;margin:8px 0;border-radius:6px;border:1px solid #ccc}
.modal-content h3{margin-bottom:12px}
.close{float:right;font-size:1.5em;cursor:pointer}

/* footer (as requested) */
footer{padding:18px;text-align:center;background:#0b3b3b;color:#fff;margin-top:24px}

/* small screen responsiveness */
@media (max-width:1000px){
  .auth-card{grid-template-columns:1fr; height:auto; width:92%}
  .auth-left{order:2;padding:18px}
  .auth-right{order:1;padding:18px}
  .logo{width:56px;height:56px}
  .header{flex-direction:column;align-items:flex-start;gap:10px}
  nav{justify-content:flex-start;padding-left:12px;overflow:auto}
  #app{padding-bottom:80px}
}

/* tiny screens */
@media (max-width:480px){
  .brand-title{font-size:20px}
  .auth-card{height:auto;padding:12px}
  .primary{padding:10px}
  .container{padding:12px}
  table{font-size:13px}
}
</style>
</head>
<body>
<div id="root">
  <!-- Particles background -->
  <canvas class="particles-canvas" id="particles"></canvas>
  <div class="soft-glow" aria-hidden="true"></div>

  <!-- AUTH WRAP (single-file approach) -->
 <div class="auth-wrap" id="authWrap" aria-hidden="false">
  <div class="auth-card" role="dialog" aria-modal="true" aria-labelledby="authTitle">
    <!-- Left panel -->
    <div class="auth-left">
      <div class="auth-header" style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div class="brand-title" id="authTitle">Medical Management System</div>
          <div class="brand-sub">Secure Access — Please sign in to continue</div>
        </div>
        <div class="logo-wrap" aria-hidden="true">
          <div class="logo">
            <img src="https://www.freepnglogos.com/uploads/medicine-logo-png-1.png" alt="Hospital Logo">
          </div>
        </div>
      </div>

      <div class="auth-welcome" style="margin-top:20px;">
        <p>Welcome to the secure Medical Management System. Sing up or create a new one.</p>
      </div>

      <div class="auth-footer" style="margin-top:auto;">
        <div class="small">Tip: Stay healthy and stay happy, stay connected.</div>
        <div class="small" style="margin-top:6px;">Developer: Nayem Sultan & Ankon Mazumder.</div>
      </div>
    </div>

      <!-- Right panel -->
    <div class="auth-right">
      <div class="auth-tabs" role="tablist">
        <div class="tab-btn active" id="tabLogin" onclick="switchAuth('login')">Login</div>
        <div class="tab-btn" id="tabSignup" onclick="switchAuth('signup')">Signup</div>
        <div class="tab-btn" id="tabForgot" onclick="switchAuth('forgot')">Forgot</div>
      </div>

      <!-- Login Panel -->
      <div class="auth-panel" id="panelLogin">
        <input class="input" id="loginUser" placeholder="Username or Email" autocomplete="username">
        <div class="input-group">
          <input class="input" id="loginPass" placeholder="Password" type="password" autocomplete="current-password">
          <span class="toggle-pass" id="loginToggle" onclick="togglePassword('loginPass','loginToggle')">Show</span>
        </div>
        <div class="btn-group">
          <button class="primary" onclick="performLogin()">Sign in</button>
        </div>
        <div class="auth-footer-row">
          <div class="small" id="loginError"></div>
          <div class="small"><a href="#" onclick="switchAuth('forgot');return false">Reset password</a></div>
        </div>
      </div>

      <!-- Signup Panel -->
      <div class="auth-panel" id="panelSignup" style="display:none;">
        <input class="input" id="signupName" placeholder="Full name">
        <input class="input" id="signupUser" placeholder="Username or Email">
        <div class="field-row">
          <input class="input" id="signupPass" placeholder="Password" type="password">
          <input class="input" id="signupPass2" placeholder="Confirm password" type="password">
        </div>
        <div class="field-row">
          <select id="signupRole" class="input">
            <option>Admin</option>
            <option>Doctor</option>
            <option>Staff</option>
          </select>
          <input class="input" id="signupPhone" placeholder="Contact (optional)">
        </div>
        <div class="btn-group">
          <button class="primary" onclick="performSignup()">Create account</button>
          <button class="ghost" onclick="switchAuth('login')">Back to login</button>
        </div>
        <div class="small" id="signupError"></div>
      </div>

      <!-- Forgot Panel -->
      <div class="auth-panel" id="panelForgot" style="display:none;">
        <div class="small">Enter username/email to reset password (simulated locally).</div>
        <input class="input" id="forgotUser" placeholder="Username or Email">
        <input class="input" id="forgotNewPass" placeholder="New Password" type="password">
        <div class="btn-group">
          <button class="primary" onclick="performForgot()">Reset</button>
          <button class="ghost" onclick="switchAuth('login')">Back</button>
        </div>
        <div class="small" id="forgotInfo" style="color:green"></div>
      </div>
    </div>
  </div>
</div>

  <!-- APP (kept inside same file) -->
  <div id="app" aria-hidden="true">
    <!-- Header -->
    <div class="header" role="banner">
      <div class="header-left">
        <h1 style="margin:0;color:#fff">Medical Management System</h1>
        <p style="margin:0;color:#eafaf4;font-size:13px">Your health, our priority</p>
      </div>
      <div class="header-actions">
        <div style="color:#fff;font-weight:600;" id="currentUserLabel">Welcome</div>
        <button onclick="logout()" style="background:transparent;color:white;border:1px solid rgba(255,255,255,0.18);padding:8px 12px;border-radius:8px;">Logout</button>
      </div>
    </div>

    <nav id="mainNav" role="navigation">
      <a href="#patients" data-sec="patients">Patients</a>
      <a href="#appointments" data-sec="appointments">Appointments</a>
      <a href="#doctors" data-sec="doctors">Doctors</a>
      <a href="#prescriptions" data-sec="prescriptions">Prescriptions</a>
      <a href="#billing" data-sec="billing">Billing</a>
      <a href="#reports" data-sec="reports">Reports</a>
    </nav>

    <main class="container" role="main">
      <!-- Counters -->
      <div class="counters">
        <div class="counter"><h2 id="patientsCounter">0</h2><p>Total Patients</p></div>
        <div class="counter"><h2 id="appointmentsCounter">0</h2><p>Total Appointments</p></div>
        <div class="counter"><h2 id="revenueCounter">৳0</h2><p>Total Revenue</p></div>
      </div>

      <!-- Patient Section -->
      <section class="section" id="patients">
        <h2>Patient Management</h2>
        <button onclick="openModal('patient')">Add New Patient</button>
        <button onclick="downloadPDF('Patients','patientsTable')" class="export-btn">Export Patients PDF</button>
        <table id="patientsTable">
          <thead><tr><th>Name</th><th>Age</th><th>Contact</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- Appointments -->
      <section class="section" id="appointments">
        <h2>Appointments</h2>
        <button onclick="openModal('appointment')">Add Appointment</button>
        <button onclick="downloadPDF('Appointments','appointmentsTable')" class="export-btn">Export Appointments PDF</button>
        <table id="appointmentsTable">
          <thead><tr><th>Date</th><th>Time</th><th>Patient</th><th>Doctor</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- Doctors -->
      <section class="section" id="doctors">
        <h2>Doctors</h2>
        <button onclick="openModal('doctor')">Add Doctor</button>
        <button onclick="downloadPDF('Doctors','doctorsTable')" class="export-btn">Export Doctors PDF</button>
        <table id="doctorsTable">
          <thead><tr><th>Name</th><th>Specialty</th><th>Contact</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- Prescriptions -->
      <section class="section" id="prescriptions">
        <h2>Prescriptions</h2>
        <button onclick="openModal('prescription')">Add Prescription</button>
        <button onclick="downloadPDF('Prescriptions','prescriptionsTable')" class="export-btn">Export Prescriptions PDF</button>
        <table id="prescriptionsTable">
          <thead><tr><th>Patient</th><th>Medicine</th><th>Dosage</th><th>Medicine</th><th>Dosage</th><th>Medicine</th><th>Dosage</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- Billing -->
      <section class="section" id="billing">
        <h2>Billing</h2>
        <button onclick="openModal('billing')">Add Billing</button>
        <button onclick="downloadPDF('Billing','billingTable')" class="export-btn">Export Billing PDF</button>
        <table id="billingTable">
          <thead><tr><th>Invoice</th><th>Patient</th><th>Date</th><th>Amount</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- Reports (fully functional) -->
      <section class="section" id="reports">
        <h2>Reports</h2>
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
          <button onclick="generateReportSummary()">Generate Summary Report</button>
          <button onclick="downloadPDF('Reports','reportsTable')" class="export-btn">Export Reports PDF</button>
          <select id="reportType" class="input" style="max-width:220px;">
            <option value="summary">Summary (counts)</option>
            <option value="patients">Patients list</option>
            <option value="appointments">Appointments list</option>
            <option value="billing">Billing transactions</option>
          </select>
        </div>

        <table id="reportsTable">
          <thead><tr><th>Type</th><th>Date</th><th>Generated By</th><th>Details</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

    </main>

    <footer>
      All rights reserved by S. M. Al Nayem Sultan. Daffodil International University 2025 — Maintenance & Developer of Medical Management System.
    </footer>
  </div>
</div>

<!-- Modal (kept intact) -->
<div class="modal" id="formModal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3 id="modalTitle">Add Item</h3>
    <form id="modalForm"></form>
  </div>
</div>

<script>
/* ============================
   Particles animation (floating soft bubbles)
   ============================ */
(function initParticles(){
  const canvas = document.getElementById('particles');
  const ctx = canvas.getContext('2d');
  let w = canvas.width = innerWidth;
  let h = canvas.height = innerHeight;
  const DPR = window.devicePixelRatio || 1;
  canvas.width = innerWidth * DPR;
  canvas.height = innerHeight * DPR;
  canvas.style.width = innerWidth + 'px';
  canvas.style.height = innerHeight + 'px';
  ctx.scale(DPR, DPR);

  let particles = [];
  const PARTICLE_COUNT = Math.max(14, Math.floor((w*h)/150000)); // scale by screen size

  function rand(min,max){ return Math.random()*(max-min)+min; }
  function createParticles(){
    particles = [];
    for(let i=0;i<PARTICLE_COUNT;i++){
      particles.push({
        x: rand(0,w),
        y: rand(0,h),
        r: rand(10,70),
        alpha: rand(0.05,0.25),
        dx: rand(-0.25,0.25),
        dy: rand(-0.15,0.15),
        drift: rand(0.2,1.2),
        hue: rand(150,200)
      });
    }
  }
  createParticles();

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(const p of particles){
      ctx.beginPath();
      const grad = ctx.createRadialGradient(p.x, p.y, p.r*0.1, p.x, p.y, p.r);
      // soft gentle teal / blue tones
      grad.addColorStop(0, `hsla(${p.hue},70%,75%,${p.alpha*1.2})`);
      grad.addColorStop(0.5, `hsla(${p.hue},60%,60%,${p.alpha*0.8})`);
      grad.addColorStop(1, `hsla(${p.hue},55%,45%,0)`);
      ctx.fillStyle = grad;
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fill();
    }
  }

  function update(){
    for(const p of particles){
      p.x += p.dx * p.drift;
      p.y += p.dy * p.drift;
      // gentle wrap around
      if(p.x - p.r > w) p.x = -p.r;
      if(p.x + p.r < 0) p.x = w + p.r;
      if(p.y - p.r > h) p.y = -p.r;
      if(p.y + p.r < 0) p.y = h + p.r;
    }
  }

  let raf;
  function loop(){
    update();
    draw();
    raf = requestAnimationFrame(loop);
  }
  loop();

  // resize handling
  window.addEventListener('resize',()=>{
    cancelAnimationFrame(raf);
    w = canvas.width = innerWidth;
    h = canvas.height = innerHeight;
    canvas.width = innerWidth * DPR;
    canvas.height = innerHeight * DPR;
    canvas.style.width = innerWidth + 'px';
    canvas.style.height = innerHeight + 'px';
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(DPR, DPR);
    createParticles();
    loop();
  });
})();

/* ============================
   Authentication & Role system (localStorage)
   ============================ */

const AUTH_KEY = 'mms_users_v1';
const SESSION_KEY = 'mms_session_v1';
const REPORTS_KEY = 'mms_reports_v1';

// Ensure default users exist
(function ensureUsers(){
  if(!localStorage.getItem(AUTH_KEY)){
    const defaults = [
      {username:'admin', name:'Nayem Sultan', password:'admin123', role:'Admin', phone:'', created:Date.now()},
      {username:'doctor', name:'Dr. Mahee', password:'doc123', role:'Doctor', phone:'', created:Date.now()},
      {username:'staff', name:'Staff Member', password:'staff123', role:'Staff', phone:'', created:Date.now()}
    ];
    localStorage.setItem(AUTH_KEY, JSON.stringify(defaults));
  }
})();

function getUsers(){ try{return JSON.parse(localStorage.getItem(AUTH_KEY)||'[]')}catch(e){return []} }
function saveUsers(list){ localStorage.setItem(AUTH_KEY, JSON.stringify(list)) }

function setSession(user){ localStorage.setItem(SESSION_KEY, JSON.stringify(user)) }
function getSession(){ try{return JSON.parse(localStorage.getItem(SESSION_KEY)||'null')}catch(e){return null} }
function clearSession(){ localStorage.removeItem(SESSION_KEY) }

/* Auth UI helpers */
function switchAuth(panel){
  document.getElementById('loginError').textContent = '';
  document.getElementById('signupError').textContent = '';
  document.getElementById('forgotInfo').textContent = '';

  document.getElementById('panelLogin').style.display = 'none';
  document.getElementById('panelSignup').style.display = 'none';
  document.getElementById('panelForgot').style.display = 'none';
  document.getElementById('tabLogin').classList.remove('active');
  document.getElementById('tabSignup').classList.remove('active');
  document.getElementById('tabForgot').classList.remove('active');

  if(panel==='login'){ document.getElementById('panelLogin').style.display='block'; document.getElementById('tabLogin').classList.add('active')}
  if(panel==='signup'){ document.getElementById('panelSignup').style.display='block'; document.getElementById('tabSignup').classList.add('active')}
  if(panel==='forgot'){ document.getElementById('panelForgot').style.display='block'; document.getElementById('tabForgot').classList.add('active')}
}

/* Toggle password visibility */
function togglePassword(inputId, toggleElId){
  const inp = document.getElementById(inputId);
  const t = document.getElementById(toggleElId);
  if(inp.type === 'password'){ inp.type='text'; if(t) t.textContent='Hide' } else { inp.type='password'; if(t) t.textContent='Show' }
}


/* Perform login */
function performLogin(){
  const ident = (document.getElementById('loginUser').value || '').trim();
  const pass = (document.getElementById('loginPass').value || '').trim();
  const err = document.getElementById('loginError');
  err.textContent = '';
  if(!ident || !pass){ err.textContent = 'Enter username and password.'; return; }
  const users = getUsers();
  const found = users.find(u => u.username.toLowerCase() === ident.toLowerCase());
  if(!found || found.password !== pass){ err.textContent = 'Invalid credentials.'; return; }
  setSession({ username: found.username, name: found.name, role: found.role });
  showAppForUser(found);
}

/* Signup */
function performSignup(){
  const name = (document.getElementById('signupName').value || '').trim();
  const username = (document.getElementById('signupUser').value || '').trim();
  const pass = (document.getElementById('signupPass').value || '').trim();
  const pass2 = (document.getElementById('signupPass2').value || '').trim();
  const role = (document.getElementById('signupRole').value || 'Staff');
  const phone = (document.getElementById('signupPhone').value || '').trim();
  const err = document.getElementById('signupError');
  err.textContent = '';
  if(!name || !username || !pass || !pass2){ err.textContent = 'Please fill required fields.'; return; }
  if(pass !== pass2){ err.textContent = 'Passwords do not match.'; return; }
  const users = getUsers();
  if(users.find(u => u.username.toLowerCase() === username.toLowerCase())){ err.textContent = 'Username already exists.'; return; }
  const newUser = { username, name, password: pass, role, phone, created:Date.now() };
  users.push(newUser);
  saveUsers(users);
  setSession({ username:newUser.username, name:newUser.name, role:newUser.role });
  showAppForUser(newUser);
}

/* Forgot (simulated) */
function performForgot(){
  const ident = (document.getElementById('forgotUser').value || '').trim();
  const newPass = (document.getElementById('forgotNewPass').value || '').trim();
  const info = document.getElementById('forgotInfo');
  info.textContent = '';
  if(!ident || !newPass){ info.style.color='red'; info.textContent='Please provide username and new password.'; return; }
  const users = getUsers();
  const idx = users.findIndex(u => u.username.toLowerCase() === ident.toLowerCase());
  if(idx === -1){ info.style.color='red'; info.textContent='User not found.'; return; }
  users[idx].password = newPass;
  saveUsers(users);
  info.style.color='green';
  info.textContent='Password reset. Please login.';
  setTimeout(()=>switchAuth('login'),1000);
}

/* Show app and apply role */
function showAppForUser(user){
  document.getElementById('authWrap').style.display = 'none';
  document.getElementById('authWrap').setAttribute('aria-hidden','true');
  document.getElementById('app').style.display = 'block';
  document.getElementById('app').setAttribute('aria-hidden','false');
  document.getElementById('currentUserLabel').textContent = user.name + ' (' + user.role + ')';
  applyRolePermissions(user.role);
  // render existing data
  renderPatients(); renderDoctors(); renderAppointments(); renderPrescriptions(); renderBilling(); renderReports();
  animateCounters();
}

/* Role-based permissions (strict) */
/* Admin: full access
   Doctor: patients, prescriptions, reports, appointments
   Staff: billing, appointments
*/
function applyRolePermissions(role){
  // all sections
  const sections = { patients:document.getElementById('patients'), appointments:document.getElementById('appointments'), doctors:document.getElementById('doctors'), prescriptions:document.getElementById('prescriptions'), billing:document.getElementById('billing'), reports:document.getElementById('reports') };
  // default hide all then show allowed
  Object.values(sections).forEach(s => s.style.display = 'none');

  if(role === 'Admin'){
    // show all
    Object.values(sections).forEach(s => s.style.display = 'block');
    // show all export buttons
    document.querySelectorAll('.export-btn').forEach(btn => btn.style.display='inline-block');
    // show nav
    document.querySelectorAll('nav a').forEach(a => a.style.display='inline-block');
  } else if(role === 'Doctor'){
    sections.patients.style.display='block';
    sections.appointments.style.display='block';
    sections.prescriptions.style.display='block';
    sections.reports.style.display='block';
    // hide exports except reports
    document.querySelectorAll('.export-btn').forEach(btn => btn.style.display='none');
    Array.from(document.querySelectorAll('button')).forEach(b=>{
      // enable only add/edit buttons in allowed sections via their parent lookup (we keep UI simple)
    });
    // nav show allowed links only
    document.querySelectorAll('nav a').forEach(a=>{
      const sec = a.getAttribute('data-sec');
      if(['patients','appointments','prescriptions','reports'].includes(sec)) a.style.display='inline-block'; else a.style.display='none';
    });
  } else if(role === 'Staff'){
    sections.appointments.style.display='block';
    sections.billing.style.display='block';
    document.querySelectorAll('.export-btn').forEach(btn => btn.style.display='none');
    document.querySelectorAll('nav a').forEach(a=>{
      const sec = a.getAttribute('data-sec');
      if(['billing','appointments'].includes(sec)) a.style.display='inline-block'; else a.style.display='none';
    });
  } else {
    // default very restricted
    sections.appointments.style.display='block';
  }
}

/* Logout */
function logout(){
  clearSession();
  // show auth again
  document.getElementById('authWrap').style.display = 'flex';
  document.getElementById('authWrap').setAttribute('aria-hidden','false');
  document.getElementById('app').style.display = 'none';
  document.getElementById('app').setAttribute('aria-hidden','true');
  switchAuth('login');
  // clear some UI fields
  document.getElementById('loginUser').value=''; document.getElementById('loginPass').value='';
}

/* Session check on load */
(function checkSessionOnLoad(){
  const session = getSession();
  if(session){
    const users = getUsers();
    const u = users.find(x=>x.username === session.username);
    if(u){ showAppForUser(u); return; }
    clearSession();
  }
  // show auth
  document.getElementById('authWrap').style.display='flex';
  switchAuth('login');
})();

/* ============================
   Your original application code (preserved)
   ============================ */

let patients = [], doctors = [], appointments = [], prescriptions = [], billing = [], reports = [];

/* ---- Open modal and create forms (kept intact) ---- */
function openModal(type, index=null) {
  const modal = document.getElementById('formModal');
  const form = document.getElementById('modalForm');
  const title = document.getElementById('modalTitle');
  form.innerHTML = '';
  title.textContent = 'Add ' + type.charAt(0).toUpperCase() + type.slice(1);

  if(type==='patient'){
    form.innerHTML = `
      <input type="text" id="name" placeholder="Name" required>
      <input type="number" id="age" placeholder="Age" required>
      <input type="text" id="contact" placeholder="Contact" required>
      <button type="submit">Save</button>`;
    form.onsubmit = e => { e.preventDefault(); savePatient(index); };
  }
  if(type==='doctor'){
    form.innerHTML = `
      <input type="text" id="name" placeholder="Name" required>
      <input type="text" id="specialty" placeholder="Specialty" required>
      <input type="text" id="contact" placeholder="Contact" required>
      <button type="submit">Save</button>`;
    form.onsubmit = e => { e.preventDefault(); saveDoctor(index); };
  }
  if(type==='appointment'){
    form.innerHTML = `
      <input type="date" id="date" required>
      <input type="time" id="time" required>
      <select id="patient">${patients.map(p=>`<option>${p.name}</option>`).join('')}</select>
      <select id="doctor">${doctors.map(d=>`<option>${d.name}</option>`).join('')}</select>
      <button type="submit">Save</button>`;
    form.onsubmit = e => { e.preventDefault(); saveAppointment(index); };
  }
  if(type==='prescription'){
    form.innerHTML = `
      <select id="patient">${patients.map(p=>`<option>${p.name}</option>`).join('')}</select>
      <input type="text" id="medicine" placeholder="Medicine" required>
      <input type="text" id="dosage" placeholder="Dosage" required>
      <input type="text" id="medicine" placeholder="Medicine" required>
      <input type="text" id="dosage" placeholder="Dosage" required>
      <input type="text" id="medicine" placeholder="Medicine" required>
      <input type="text" id="dosage" placeholder="Dosage" required>
      <button type="submit">Save</button>`;
    form.onsubmit = e => { e.preventDefault(); savePrescription(index); };
  }
  if(type==='billing'){
    form.innerHTML = `
      <input type="text" id="invoice" placeholder="Invoice #" required>
      <select id="patient">${patients.map(p=>`<option>${p.name}</option>`).join('')}</select>
      <input type="date" id="date" required>
      <input type="number" id="amount" placeholder="Amount" required>
      <select id="status"><option>Paid</option><option>Pending</option></select>
      <button type="submit">Save</button>`;
    form.onsubmit = e => { e.preventDefault(); saveBilling(index); };
  }

  modal.style.display = 'block';
}

function closeModal() { document.getElementById('formModal').style.display='none'; }

/* ---- Save handlers ---- */
function savePatient(i=null){
  const name = document.getElementById('name').value;
  const age = document.getElementById('age').value;
  const contact = document.getElementById('contact').value;
  if(i!==null){ patients[i]={name,age,contact}; } else { patients.push({name,age,contact}); }
  closeModal(); renderPatients(); animateCounters();
}

function saveDoctor(i=null){
  const name = document.getElementById('name').value;
  const specialty = document.getElementById('specialty').value;
  const contact = document.getElementById('contact').value;
  if(i!==null){ doctors[i]={name,specialty,contact}; } else { doctors.push({name,specialty,contact}); }
  closeModal(); renderDoctors();
}

function saveAppointment(i=null){
  const date = document.getElementById('date').value;
  const time = document.getElementById('time').value;
  const patient = document.getElementById('patient').value;
  const doctor = document.getElementById('doctor').value;
  if(i!==null){ appointments[i]={date,time,patient,doctor}; } else { appointments.push({date,time,patient,doctor}); }
  closeModal(); renderAppointments(); animateCounters();
}

function savePrescription(i = null) {
  const patientVal = document.getElementById('patient').value;
  const medicine = document.getElementById('medicine').value;
  const dosage = document.getElementById('dosage').value;

  if (i !== null) {
    prescriptions[i] = { patient: patientVal, medicine, dosage };
  } else {
    prescriptions.push({ patient: patientVal, medicine, dosage });
  }

  closeModal();
  renderPrescriptions();
}


function saveBilling(i=null){
  const invoice=document.getElementById('invoice').value;
  const patient=document.getElementById('patient').value;
  const date=document.getElementById('date').value;
  const amount=parseFloat(document.getElementById('amount').value);
  const status=document.getElementById('status').value;
  if(i!==null){ billing[i]={invoice,patient,date,amount,status}; } else { billing.push({invoice,patient,date,amount,status}); }
  closeModal(); renderBilling(); animateCounters();
}

/* ---- Render functions ---- */
function renderPatients(){
  const tbody=document.getElementById('patientsTable').querySelector('tbody');
  tbody.innerHTML='';
  patients.forEach((p,i)=>{
    tbody.innerHTML+=`<tr><td>${p.name}</td><td>${p.age}</td><td>${p.contact}</td>
      <td><button onclick="editPatient(${i})">Edit</button><button onclick="deletePatient(${i})">Delete</button></td></tr>`;
  });
}

function renderDoctors(){
  const tbody=document.getElementById('doctorsTable').querySelector('tbody');
  tbody.innerHTML='';
  doctors.forEach((d,i)=>{
    tbody.innerHTML+=`<tr><td>${d.name}</td><td>${d.specialty}</td><td>${d.contact}</td>
      <td><button onclick="editDoctor(${i})">Edit</button><button onclick="deleteDoctor(${i})">Delete</button></td></tr>`;
  });
}

function renderAppointments(){
  const tbody=document.getElementById('appointmentsTable').querySelector('tbody');
  tbody.innerHTML='';
  appointments.forEach((a,i)=>{
    tbody.innerHTML+=`<tr><td>${a.date}</td><td>${a.time}</td><td>${a.patient}</td><td>${a.doctor}</td>
      <td><button onclick="editAppointment(${i})">Edit</button><button onclick="deleteAppointment(${i})">Delete</button></td></tr>`;
  });
}

function renderPrescriptions(){
  const tbody=document.getElementById('prescriptionsTable').querySelector('tbody');
  tbody.innerHTML='';
  prescriptions.forEach((p,i)=>{
    tbody.innerHTML+=`<tr><td>${p.patient}</td><td>${p.medicine}</td><td>${p.dosage}</td><td>${p.medicine}</td><td>${p.dosage}</td><td>${p.medicine}</td><td>${p.dosage}</td>
      <td><button onclick="editPrescription(${i})">Edit</button><button onclick="deletePrescription(${i})">Delete</button></td></tr>`;
  });
}

function renderBilling(){
  const tbody=document.getElementById('billingTable').querySelector('tbody');
  tbody.innerHTML='';
  billing.forEach((b,i)=>{
    tbody.innerHTML+=`<tr><td>${b.invoice}</td><td>${b.patient}</td><td>${b.date}</td><td>৳${b.amount}</td><td>${b.status}</td>
      <td><button onclick="editBilling(${i})">Edit</button><button onclick="deleteBilling(${i})">Delete</button></td></tr>`;
  });
}

/* ---- Edit / Delete functions ---- */
function editPatient(i){ openModal('patient',i); document.getElementById('name').value=patients[i].name; document.getElementById('age').value=patients[i].age; document.getElementById('contact').value=patients[i].contact;}
function editDoctor(i){ openModal('doctor',i); document.getElementById('name').value=doctors[i].name; document.getElementById('specialty').value=doctors[i].specialty; document.getElementById('contact').value=doctors[i].contact;}
function editAppointment(i){ openModal('appointment',i); document.getElementById('date').value=appointments[i].date; document.getElementById('time').value=appointments[i].time; document.getElementById('patient').value=appointments[i].patient; document.getElementById('doctor').value=appointments[i].doctor;}
function editPrescription(i){ openModal('prescription',i); document.getElementById('patient').value=prescriptions[i].patient; document.getElementById('medicine').value=prescriptions[i].medicine; document.getElementById('dosage').value=prescriptions[i].dosage;}
function editBilling(i){ openModal('billing',i); document.getElementById('invoice').value=billing[i].invoice; document.getElementById('patient').value=billing[i].patient; document.getElementById('date').value=billing[i].date; document.getElementById('amount').value=billing[i].amount; document.getElementById('status').value=billing[i].status;}

function deletePatient(i){ if(confirm('Delete this patient?')){ patients.splice(i,1); renderPatients(); animateCounters(); }}
function deleteDoctor(i){ if(confirm('Delete this doctor?')){ doctors.splice(i,1); renderDoctors(); }}
function deleteAppointment(i){ if(confirm('Delete this appointment?')){ appointments.splice(i,1); renderAppointments(); animateCounters(); }}
function deletePrescription(i){ if(confirm('Delete this prescription?')){ prescriptions.splice(i,1); renderPrescriptions(); }}
function deleteBilling(i){ if(confirm('Delete this billing?')){ billing.splice(i,1); renderBilling(); animateCounters(); }}

/* ---- Counters ---- */
function animateCounters(){
  document.getElementById('patientsCounter').innerText = patients.length;
  document.getElementById('appointmentsCounter').innerText = appointments.length;
  let totalRevenue = billing.reduce((a,b)=>a+(b.amount||0),0);
  document.getElementById('revenueCounter').innerText = '৳'+totalRevenue;
}

/* ---- PDF Export (kept intact) ---- */
function downloadPDF(title, tableId){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text(title,20,20);
  const table=document.getElementById(tableId);
  let rows=[];
  for(let i=0;i<table.rows.length;i++){
    let row=[];
    for(let j=0;j<table.rows[i].cells.length;j++){
      row.push(table.rows[i].cells[j].innerText);
    }
    rows.push(row);
  }
  if(rows.length>0){
    doc.autoTable({head:[rows[0]], body:rows.slice(1), startY:30});
  }
  doc.save(title+'.pdf');
}

/* ============================
   Reports: generation + storage + UI
   ============================ */

function getStoredReports(){ try{return JSON.parse(localStorage.getItem(REPORTS_KEY)||'[]')}catch(e){return []} }
function saveStoredReports(r){ localStorage.setItem(REPORTS_KEY, JSON.stringify(r)) }

function generateReportSummary(){
  // check role permission
  const session = getSession();
  if(!session){ alert('Please login'); return; }
  const role = session.role;
  // allowed roles: Admin
  if(!['Admin'].includes(role)){ alert('You do not have permission to generate reports.'); return; }

  const type = document.getElementById('reportType').value || 'summary';
  const now = new Date().toISOString();
  let details = '';

  if(type === 'summary'){
    details = `Patients: ${patients.length}, Appointments: ${appointments.length}, Billing total: ৳${billing.reduce((a,b)=>a+(b.amount||0),0)}, Prescriptions: ${prescriptions.length}`;
    addReport('Summary', now, session.username, details);
  } else if(type === 'patients'){
    details = patients.map(p=>`${p.name} (${p.age})`).join('; ');
    addReport('Patients List', now, session.username, details);
  } else if(type === 'appointments'){
    details = appointments.map(a=>`${a.date} ${a.time} - ${a.patient} with ${a.doctor}`).join('; ');
    addReport('Appointments List', now, session.username, details);
  } else if(type === 'billing'){
    details = billing.map(b=>`${b.invoice}: ${b.patient} ৳${b.amount} (${b.status})`).join('; ');
    addReport('Billing Transactions', now, session.username, details);
  } else {
    addReport('Report', now, session.username, 'Custom report generated.');
  }
  renderReports();
}

function addReport(type, dateISO, generatedBy, details){
  const r = getStoredReports();
  r.unshift({ type, date:dateISO, generatedBy, details });
  saveStoredReports(r);
  reports = r;
}

/* render reports to table */
function renderReports(){
  reports = getStoredReports();
  const tbody = document.getElementById('reportsTable').querySelector('tbody');
  tbody.innerHTML = '';
  reports.forEach((r,i)=>{
    const d = new Date(r.date).toLocaleString();
    const detailsShort = (r.details && r.details.length>120) ? r.details.slice(0,120)+'...' : r.details;
    tbody.innerHTML += `<tr><td>${r.type}</td><td>${d}</td><td>${r.generatedBy}</td><td title="${escapeHtml(r.details)}">${detailsShort}</td></tr>`;
  });
}

/* helper to escape attribute text */
function escapeHtml(str){
  return (str||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,"&#39;");
}

/* ============================
   Demo preload data (only once)
   ============================ */
(function preloadDemoData() {
  if (!localStorage.getItem('mms_demo_data')) {
    patients = [
      { name: 'Nayem Sultan', age: 23, contact: '01811531286' },
      { name: 'Ankon Mazumder', age: 25, contact: '01767644777' }
    ];

    doctors = [
      { name: 'Nishat Tasnim Madam', specialty: 'Web Engineering', contact: '017xxxxxxxx' },
      { name: 'Dr. Rahman', specialty: 'ENT', contact: '019xxxxxxxx' }
    ];

    appointments = [
      { date: '2025-12-11', time: '10:30', patient: 'John Doe', doctor: 'Nishat Tasnim Madam' }
    ];

    billing = [
      { invoice: 'INV001', patient: 'Nayem Sultan', date: '2025-12-11', amount: 1200, status: 'Paid' }
    ];

    // Corrected prescriptions: each medicine is its own object
    prescriptions = [
      { patient: 'Nayem Sultan', medicines: [
          { name: 'Paracetamol', dosage: '500mg' },
          { name: 'Nexcital', dosage: '5mg' },
          { name: 'Osartil', dosage: '50mg' }
        ]
      }
    ];

    reports = [];

    localStorage.setItem('mms_demo_data', '1');
    // persist initial demo content to localStorage? no, we keep in-memory so user can start editing
  } else {
    // keep arrays empty by default; user will add
  }

  // initial render if session already exists
  const session = getSession();
  if (session) {
    renderPatients(); 
    renderDoctors(); 
    renderAppointments(); 
    renderPrescriptions(); 
    renderBilling(); 
    renderReports(); 
    animateCounters();
  }
})();

/* ============================
   Accessibility: modal keyboard shortcuts
   ============================ */
document.addEventListener('keydown', function(e){
  // Get all modals
  const modals = document.querySelectorAll('.modal'); // Add class="modal" to all modals
  modals.forEach(modal => {
    if(modal.style.display === 'block'){
      // Close on Escape
      if(e.key === 'Escape'){
        closeModal(modal.id); // Pass modal id if needed
      }

      // Trigger Enter action
      if(e.key === 'Enter'){
        handleModalEnter(modal.id); // Call a function depending on modal
      }
    }
  });
});

/* ============================
   Small UX: clicking outside modal closes
   ============================ */
document.getElementById('formModal').addEventListener('click', function(e){
  if(e.target === this) closeModal();
});

</script>
</body>
</html>
